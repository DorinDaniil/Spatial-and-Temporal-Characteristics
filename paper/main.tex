\documentclass[a4paper, 12pt]{extarticle}

\input{preamble.tex}
\input{newcommands}
\renewcommand{\abstractname}{Аннотация}

\title{Пространственно-временные характеристики в задаче декодирования данных фМРТ}

\author{
	Дорин Даниил \\
	\texttt{dorin.dd@phystech.edu} \\
	\And
	Грабовой Андрей \\
	\texttt{grabovoy.av@phystech.edu}
        \And
        Стрижов Вадим \\
	\texttt{strijov@gmail.com} \\
}
\date{\today}

\begin{document}
\maketitle

\begin{abstract}

	Исследуются пространственно-временные характеристики в задаче декодирования данных функциональной магнитно-резонансной томографии или фМРТ с дискретным представлением времени. Нейросетевые архитектуры не всегда подходят для работы с данными фМРТ из-за ограниченного объема данных, высокой индивидуальной вариабельности и необходимости значительных вычислительных ресурсов. Поэтому рассматривается подход, учитывающий особенности строения мозга каждого исследуемого объекта.
    Предложен метод снижения пространственной размерности временных рядов фМРТ, основанный на взвешивании стимулированных областей мозга с использованием кросс-корреляционной функции. На основе этого метода предложена модель классификации сегментов временных рядов фМРТ, использующая кодировщик с применением римановой геометрии для извлечения пространственно-временных характеристик. В вычислительном эксперименте проводится анализ предложенных методов на выборке, полученной при томографическом обследовании шести испытуемых. Проанализировано влияние отдельных компонент метода на качество классификации.

\end{abstract}


\keywords{пространственно-временные характеристики \and нейровизуализация \and фМРТ \and риманова геометрия \and  классификация}

\section{Введение}\label{intro}

Совокупность методов, визуализирующих структуру и функции человеческого мозга,
называется \textit{нейровизуализацией}. Методы нейровизуализации \cite{puras2014neurovisualization} такие, как ЭКГ, КТ, МРТ и фМРТ,
используются для изучения мозга, а также для обнаружения заболеваний и психических расстройств. В рамках данной работы, основным объектом исследования являются временные ряды фМРТ.

\textit{Функциональная магнитно-резонансная томография} или \textit{фМРТ}
является разновидностью магнитно-резонансной томографии и основана на изменениях в токе крови,
вызванных нейронной активностью мозга \cite{Glover2011}.
Эти изменения происходят не моментально, а с некоторой задержкой,
которая составляет 4--8 с \cite{Bandettini1992}.
Она возникает из-за того, что сосудистая система достаточно долго реагирует
на потребность мозга в глюкозе \cite{Ogawa1990, LEBIHAN1995231, Logothetis2003}.

При получении снимков фМРТ используются последовательности
эхопланарных изображений (EPI) \cite{Connelly1993, Kwong1992, Ogawa1992}.
Обработка участков с изменяющейся интенсивностью сигнала в
зависимости от способа активации, вида артефактов и длительности
проводится с помощью специальных методов и программ
\cite{Bandettini1992, BAUDENDISTEL1995701, COX1996162}.
Обработанные результаты оформляются в виде карт активации,
которые совмещаются с локализацией анатомических образований
головного мозга.

Метод фМРТ играет большую роль в нейровизуализации, однако имеет ряд важных ограничений.
В работах \cite{menon1999spatial, logothetis2008we} рассматриваются
временное и пространственное разрешения фМРТ. Временное разрешение является существенным
недостатком данного метода, так как частота снимков обычно мала. Другой недостаток фМРТ~--- неизбежно возникающие шумы,
связанные с движением объекта в сканере, сердцебиением и дыханием человека, тепловыми
флуктуациями самого прибора и т.\,д. В работе \cite{1804.10167} предлагаются методы
подавления вышеперечисленных шумов на основе графов и демонстрируется их эффективность в задаче
выявления эпилепсии и депрессии.

При проведении фМРТ испытуемому дают различные тест-задания и
применяют внешние раздражители, вызывающие активацию определенных
локальных участков головного мозга, ответственных за выполнение
соответствующих функций.
Среди тест-заданий зачастую выделяют движения пальцами и конечностями
\cite{Roux1998, Papke1999}, просмотр изображений различных категорий, рассмотрение
шахматной доски \cite{Engel1994, Schneider1994},
прослушивание неспецифичных шумов, единичных слов
или связного текста \cite{Binder1994, Dymarkowski1998}.

В последнее время активно ведутся научные исследования,
посвященные методам анализа активности головного мозга и декодирования информации \cite{siuly2016eeg, grabovoy2020quasi, yuan2021bci, du2022fmri}. Основу применения этих методов составляют технологии нейрокомпьютерных интерфейсов.
Интерфейсы мозг-компьютер или ИМК \cite{wolpaw2000brain} являются относительно новой, но быстро развивающейся областью исследований методов нейровизуализации \cite{bularka2016brain}.
Технология ИМК открывает новый способ взаимодействия мозга с компьютером.
Система собирает сигналы мозга, анализирует их и преобразует сигналы в команды, которые могут быть отправлены на устройство
вывода для выполнения определенного действия \cite{mcfarland2002brain}.
Это позволяет осуществлять прямую связь между мозгом и компьютером.
Ключевой целью исследований ИМК является разработка нового канала связи, который позволяет людям с тяжелыми нервно-мышечными нарушениями напрямую передавать сообщения из своего мозга путем анализа умственной активности \cite{makeig2004mining}.
Классификация моторных образов в задаче ИМК может быть использована, например, для управления протезами или другими устройствами с помощью мысленных команд \cite{song2020assistive, cruz2021self, schwarz2020decoding}. Такой подход позволяет людям с ограниченными возможностями компенсировать потерю или отсутствие нормальной моторной функции.

Применение римановой геометрии в анализе данных электроэнцефалографии или ЭЭГ уже продемонстрировало свою эффективность в выявлении пространственно-временных характеристик сигналов мозга \cite{congedo2017riemannian, barachant2011multiclass, yger2016riemannian}. Риманова геометрия позволяет анализировать сигналы ЭЭГ в пространстве ковариационных матриц, что обеспечивает более полное понимание нейронных процессов \cite{barachant2011channel}. Вместо традиционного подхода, который рассматривает данные как точки в евклидовом пространстве, риманова геометрия позволяет эффективно работать с матрицами ковариации, представляя их как точки на многообразии \cite{barachant2010riemannian}. Эти результаты были успешно применены в задачах классификации \cite{samokhina2022classification} моторных образов \cite{guan2019motor, xie2022multiple}, распознавания эмоций \cite{wu2022novel} и диагностики заболеваний \cite{shariat2021automatic, kloppel2012diagnostic}. Учитывая успех римановой геометрии в анализе ЭЭГ сигналов, представляет интерес ее применение к другим типам нейровизуализационных данных, таким как фМРТ, что является одним из объектов исследования настоящей работы.

Активные области мозга, ответственные за конкретную задачу, называются регионами интереса (ROI). Выделение регионов интереса является важным шагом в предварительной обработке данных ЭЭГ, фМРТ и других методов нейровизуализации, используемых в нейрокомпьютерных интерфейсах \cite{poldrack2007region}. Данные фМРТ представляют собой объемные многомерные наборы данных.
При этом значительная доля вокселей фМРТ соответствует фоновому изображению, которое может вносить существенный шум при решении задачи декодирования сигнала.
Кроме того, необходимо учитывать, что конкретные области мозга отвечают за выполнение определенных зрительных, когнитивных и моторных задач \cite{altenmuller2002brain}.
Таким образом, при анализе снимков фМРТ важным аспектом является корректное выделение регионов интереса, ответственных за выполнение конкретной задачи.

Анализ данных фМРТ имеет важное значение для понимания работы мозга и развития нейронаук и когнитивной психологии \cite{logothetis2008we, bandettini2012twenty}. Одной из ключевых задач в этом направлении является классификация сегментов временных рядов фМРТ, которая может позволить глубже понять механизмы работы мозга \cite{haxby2001distributed}. 

В настоящей работе рассматривается задача классификации данных фМРТ как задача декодирования временных рядов. Для решения этой задачи предлагается метод взвешивания вокселей фМРТ, учитывающий пространственно-временные зависимости в данных. Этот метод основан на вычислении кросс-корреляционной функции между данными фМРТ и временным рядом стимула. На основе этого метода строится модель классификации сегментов временного ряда фМРТ, учитывающая пространственные характеристики за счет выделения регионов интереса и последующей трансформации пространства признаков в терминах римановой геометрии \cite{barachant2010riemannian, barachant2011multiclass}. Кроме того, обычно данных конкретного пациента недостаточно для обучения сложных моделей, поскольку объем данных одного пациента ограничен и не может обеспечить необходимую вариативность и репрезентативность для обучения точной модели. Поэтому предлагается метод сегментации временного ряда фМРТ с целью аугментации данных и обучения модели под конкретного пациента. 

Чтобы оценить эффективность разработанных методов, проведен вычислительный эксперимент на данных фМРТ из исследования Haxby \cite{haxby2001distributed}. Набор данных включает в себя записи мозговой активности шести испытуемых, которые во время эксперимента просматривали визуальные стимулы восьми различных категорий.

\section{Постановка задачи}
В данном разделе рассматриваются две задачи анализа данных фМРТ: сегментация временного ряда на сегменты фиксированной длины с преобладающей категорией стимула и классификация сегментов для определения класса стимула.
\subsection{Задача сегментации временного ряда фМРТ}
При анализе медицинских данных важно учитывать уникальные особенности анатомии и реакции каждого пациента на стимулы. Для более точного декодирования данных необходимо обучать модель индивидуально под конкретного индивида. В медицинских наборах данных обычно представлено только одно большое измерение для каждого пациента. Для решения конкретных задач необходимо разбить или сегментировать временной ряд для дальнейшего анализа. 

\begin{definition}
Фрагментом временного ряда $\bX = [\bx_1, \dots, \bx_T]$ будем называть любую его подпоследовательность $\mathbf{\hat{X}}:$ $$\mathbf{\hat{X}} = [\bx_{(t_1)}, \dots, \bx_{(t_k)}], \quad 1 \leqslant t_1 < \ldots < t_k \leqslant T.$$
\end{definition}
\begin{definition}
Сегментом временного ряда $\bX = [\bx_1, \dots, \bx_T]$ будем называть его непрерывный фрагмент $\mathbf{\hat{X}}:$
$$\mathbf{\hat{X}} = [\bx_{(t)}]_{t=t_0}^{t_1}, \quad \quad 1 \leqslant t_0 < t_1 \leqslant T.$$
Тогда длиной сегмента называется число $\tau = t_1 - t_0 + 1$.
\end{definition}

\begin{definition}
Под сегментацией временного ряда будем понимать отображение $\mathcal{G}$, сопоставляющее временному ряду $\bX$ множество его сегментов $\mathcal{G}(\bX) \in 2^{\mathcal{S}(\bX)}$, где $\mathcal{S}(\bX)$ множество всех сегментов временного ряда $\bX$.
\end{definition}

\begin{definition}
    Под стимулами будем понимать зрительные, моторные или когнитивные задания различных категорий, которые выполняет человек в ходе процедуры фМРТ.
\end{definition}
Формализуем задачу сегментации временного ряда фМРТ. Имеется одно непрерывное измерение фМРТ с дискретным представлением времени:
\begin{equation*}
	\bX = [\bx_{1}, \ldots, \bx_{T}], \quad \bx_{t} \in \mathbb{R}^{X \times Y \times Z},
\end{equation*}
где $X, Y$ и $Z$~--- размерности тензора снимка, $T$~--- длина временного ряда. 
Имеется дискретный временной ряд стимулов:
\begin{equation*}
	\bm{s} = [{s}_{1}, \ldots, {s}_{T}], \quad {s}_{t} \in \{0,\dots, C\},
\end{equation*}
где $\{1,\dots, C\}$~--- множество классов стимулов.
Классом $0$ обозначены моменты отдыха пациента.

Необходимо построить сегментацию $\mathcal{G}(\bX, \bm{s})$ временного ряда $\bX$ на сегменты фиксированной длины $\tau$, чтобы в сегментах преобладала определенная категория стимула.

\subsection{Задача классификация сегментов временного ряда фМРТ}
Задано $N$ сегментов временных рядов фМРТ длины $\tau$:
\begin{equation*}
    \bX = \{\bX_1, \bX_2, \ldots, \bX_N \},
\end{equation*}
\begin{equation*}
    \bX_i = [\bx_{1}^i, \bx_{2}^i, \ldots, \bx_{\tau}^i],
\end{equation*}
где $\bx_{t}^i \in \mathbb{R}^{X \times Y \times Z}$~--- это тензор снимка в момент времени $t$ для набора $i$.
Каждому наблюдению соответствует метка $y_i \in \{1,\dots, C\}$, где $C$~--- число классов. Имеется выборка:
\begin{equation*}
    \mathfrak{D} = \{(y_i, \bX_i) \ | \ i = 1, \ldots, N \}.
\end{equation*}
Требуется построить модель классификации $g$, которая учитывает пространственно-временные характеристики рядов фМРТ:
\begin{equation}
    g: \bX \rightarrow \{1,\dots, C\}.
\end{equation}

\section{Описание методов}
В разделе описаны методы сегментации временных рядов фМРТ, взвешивания вокселей с помощью кросс-корреляции для выделения активных областей мозга, а также классификации сегментов временных рядов с использованием полученных масок активности.
\subsection{Сегментация временного ряда фМРТ}\label{segmentation}
Задан временной ряд фМРТ $\bX$ и соответствующий временной ряд стимулов $\bm{s}$:
\begin{equation*}
\bX = \left[\bx_{1}, \ldots, \bx_{T}\right], \quad \bx_{t} \in \mathbb{R}^{X \times Y \times Z},
\end{equation*}
\begin{equation*}
\bm{s} = \left[{s}_{1}, \ldots, {s}_{T}\right], \quad {s}_{t} \in \{0,\dots, C\}.
\end{equation*}

\begin{assumption}
    Пациент имел достаточное время для отдыха между демонстрацией стимулов разных категорий. Формально, существует $\tau \neq 0$: для любого выбранного сегмента длины $\tau$ суммарная длина моментов стимулирования $\hat{\tau} < \tau$.
    \label{assumption:1}
\end{assumption}

Построим сегментацию $\mathcal{G}(\bX, \bm{s})$ временного ряда $\bX$. Зафиксируем $\tau$ согласно предположению \ref{assumption:1}.
Для каждой категории $k \in \{1,\dots,C\}$ выделим из временного ряда $\bX$ сегменты длины $\tau$, используя алгоритм.
На первом этапе находим индексы начала и конца отрезков, соответствующих классу стимула $k$. 
Обозначим индексы в порядке возрастания $\{b_{1}, \ldots, b_{n_{k}}\}$ и $\{e_{1}, \ldots, e_{n_{k}}\}$ соответственно, 
где $n_{k}$~--- число отрезков, отвечающих категории $k$. 
\begin{equation*}
\{b_{1}, \ldots, b_{n_{k}}\} = \{t \mid {s}_{t}=k, {s}_{t-1}=0\},
\end{equation*}
\begin{equation*}
\{e_{1}, \ldots, e_{n_{k}}\} = \{t \mid {s}_{t}=k, {s}_{t+1}=0\}.
\end{equation*}
На втором этапе для каждого сегмента $[b_{j},~e_{j}] \subset [1,~T]$ длины $\tau_{j} = e_{j} - b_{j} + 1$ добавим слева и 
	справа сегменты, отвечающие моментам отдыха пациент,  
	чтобы получить отрезок длины $\tau$:
	\begin{equation*}
	\bX_{j} = [\bx_{b_{j}-\delta_1}, \ldots, \bx_{e_{j}+\delta_2}],
	\end{equation*}
	\begin{equation*}
		\bm{s}_{j} = [s_{b_{j}-\delta_1}, \ldots, s_{e_{j}+\delta_2}],
	\end{equation*}
	где $j = 1,\ldots, n_{k}, \quad \delta_1 = \lfloor (\tau - \tau_{j})/2 \rfloor$, $\delta_2 = \lceil (\tau - \tau_{j})/2 \rceil$. Здесь $\lfloor \cdot \rfloor$ и $\lceil \cdot \rceil$ обозначают операции округления в меньшую и большую сторону соответственно.
    В силу предположения \ref{assumption:1} для каждой категории $k$ выполняется $\tau_{j} < \tau,\quad j = 1,\ldots, n_{k}$.

В результате объединения по всем категориям получим $N = \sum_{k=1}^C n_k$ сегментов временного ряда длины $\tau$.



\subsection{Взвешивание вокселей фМРТ снимков}\label{CCW}
Прежде чем перейти к модели классификации необходимо определить метод взвешивания активных областей мозга или \textit{Cross-Correlation Weighting (CCW)}. Введем два предположения необходимых для построения алгоритма.
\begin{assumption}
        Наличие неизменяющегося времени гемодинамической ответной реакции зависимости уровня кислорода в крови $\Delta t$.
        \label{delta_t}
\end{assumption}
\begin{assumption}
        Если область мозга реагирует на стимул, то значение кросс-корреляционной функции для вокселей из этой области ожидается большим.
\end{assumption}
\noindentЗадан временной ряд фМРТ $\bX$ с частотой $\mu$ и бинарный временной ряд стимула $\bm{s}$:
\begin{equation*}
\bX = \left[\bx_{1}, \ldots, \bx_{\tau}\right], \quad \bx_{t} \in \mathbb{R}^{X \times Y \times Z},
\end{equation*}
\begin{equation*}
\bm{s} = \left[{s}_{1}, \ldots, {s}_{\tau}\right], \quad {s}_{t} \in \{0,~1\}.
\end{equation*}
\textbf{Алгоритм взвешивания вокселей:}\\
\vspace{-0.7cm}
\begin{enumerate}
\item \textbf{3D Average Pooling}: сжатие 3D Average Pooling каждого тензора фМРТ с размером ядра $k_s$: $\bX \rightarrow \bX'$.

\item \textbf{Z-нормализация}: нормализация временного ряда каждого вокселя в $\bX'$ и временного ряда $\bm{s}$ путем вычитания их выборочного среднего и деления на несмещенную оценку стандартного отклонения: $\bX' \rightarrow \hat{\bX}',~\bm{s} \rightarrow \hat{\bm{s}}$.

\item \textbf{Вычисление кросс-корреляции}: для каждой тройки индексов $(i,~j,~k)$ определим функцию кросс-корреляции между временным рядом вокселя $\bm{v}^{i,j,k}$ и временным рядом стимула $\hat{\bm{\bm{s}}}$:

\begin{equation}
    c_{i,j,k}\left(p\right) = \left(\hat{\bm{\bm{s}}} * \bm{v}^{i,j,k}\right)\left(p\right)=\dfrac{1}{\tau-1}\sum_{t=1}^{\tau-p} \hat{s}_{t} \cdot v^{i,j,k}_{t+p}, \quad p = 0, \ldots, \tau-1.
\end{equation}

\item \textbf{Определение маски}: вычислим дискретный момент времени $p_{\Delta t} = \lfloor\mu\Delta t \rfloor$, соответствующий задержке $\Delta t$. 
Находим значение кросс-корреляционной функции $c_{i,j,k}(p_{\Delta t})$ для каждой тройки индексов $(i,~j,~k)$. 
Создаем тензор $\mathcal{M}_c \in \{0\}^{X/ k_s \times Y/ k_s \times Z/ k_s}$ и присваиваем единицы для значений тензора в позициях $(i,~j,~k)$, соответствующих $h$ наибольшим значениям $c_{i,j,k}(p_{\Delta t})$. 

\item \textbf{Обратная свертка}: выполняем операцию обратной свертки, чтобы получить тензор $\mathcal{M} \in \{0, 1\}^{X \times Y \times Z}$.
Каждому элементу тензора $\mathcal{M}_c \in \{0, 1\}^{X/ k_s \times Y/ k_s \times Z/ k_s}$ назначаем маленький тензор размером $k_c \times k_c \times k_c$.
\end{enumerate}
\noindentМетод имеет три настраиваемых параметра: размер ядра $k_c$, время гемодинамической ответной реакции $\Delta t$ и число активных областей $h$.

Для проверки статистической значимости областей, полученных с помощью метода \textit{Cross-Correlation Weighting}, предлагается проверить значимость корреляции между временным рядом стимула и временным рядом каждого вокселя фМРТ. Рассмотрим временной ряд $\bm{v}$ каждого вокселя фМРТ и временной ряд стимула $\bm{s}$, обозначим $\tau_{\bm{v}\bm{s}}$~--- выборочный коэффициент корреляции Кенделла. Тогда применим следующий критерий:
\begin{center}
			\begin{tabular}{rl}
				выборки:                        & $\bm{v}=\left[v_{1},\ldots,v_{\tau}\right]$\\
				                                & $\bm{s}=\left[s_{1},\ldots,s_{\tau}\right]$\\
				                                & выборки связанные\\
				нулевая гипотеза:               & $H_0\colon \tau_{\bm{v}\bm{s}}=0$ \\
				альтернатива:                   & $H_1\colon \tau_{\bm{v}\bm{s}}>0$ \\
				статистика:                     & $\hat{\tau}_{\bm{v}\bm{s}}$ \\
				нулевое распределение:          & табличное\\
			\end{tabular}
		\end{center}
При справедливости $H_0$:
$$\mathbb{E}\hat{\tau}_{\bm{v}\bm{s}} = 0, \;\; \mathbb{D}\hat{\tau}_{\bm{v}\bm{s}} = \frac{2\left(2\tau+5\right)}{9\tau\left(\tau-1\right)}.$$
Ставится задача множественного тестирования гипотез, так как критерий применяется для каждого вокселя фМРТ. Для контроля FWER на уровне значимости $\alpha$ используется поправка Холма на множественное тестирование гипотез. 
Таким образом, получаем позиции вокселей, где корреляция статистически значима. 

\subsection{Классификация сегментов временного ряда фМРТ}
На Рис.~\ref{fig:scheme_2} приведена схема модели классификации. Имеется $N$ сегментов временного ряда фМРТ длины $\tau$. Кроме того, для каждого сегмента задан временной ряд стимула и метка класса.
\begin{figure}[h!]
	\centering
	\includegraphics[width=1\textwidth]{figures/scheme.pdf}
	\caption{\textbf{Схема метода.} Метод строится из двух компонент~--- извлечение масок активности головного мозга для каждой категории стимула и классификации с учетом полученных масок.}
	\label{fig:scheme_2}
\end{figure}
\begin{equation*} 
		\bX = \{\bX_1,\dots, \bX_{N}\},
	\end{equation*}
	\begin{equation*}
		\bX_j = [\bx_{1}^j, \ldots, \bx_{\tau}^j], \quad
		\bx_{t}^j \in \mathbb{R}^{X \times Y \times Z},
	\end{equation*}
	$$\bm{s}_j = \left[s_1^j, \dots, s_{\tau}^j\right], \quad s_t \in \{0,~1\},$$
	$$\bm{y} = \left[y_1, \dots, y_{N}\right],\quad y_j \in \{1,\dots, C\}.$$
 \paragraph*{Извлечение масок активности мозга для каждой категории стимула.}
 Получение маски активности мозга для каждой категории стимула выделяет специфичные для каждого класса области мозга, которые активируются в ответ на соответствующий стимул. Пусть задана выборка:
\begin{equation*}
    \mathfrak{D} = \{(\bX_{j}, \bm{s}_j, y_j) \ | \ {j} = 1, \ldots, N \}.
\end{equation*}

Без ограничения общности рассмотрим произвольный класс $k \in \{1, \ldots, C\}$. Выделим подвыборку $\mathfrak{D}_k$, соответствующую классу $k$, и перенумеруем для удобства объекты подвыборки:
\begin{equation*}
    \mathfrak{D}_k = \{(\bX_j, \bm{s_j}, y_j) \in \mathfrak{D}\ | \ y_j = k\} = \{(\bX_j, \bm{s_j})\ | \ j = 1,\ldots, N_k\}.
\end{equation*}
При использовании метода \textit{Cross-Correlation Weighting} на отдельном объекте подвыборки нет гарантии, что полученная маска соответствует нужной области мозга, отвечающей стимулированию класса $k$. Это связано в первую очередь с ограничениями и недостатками процедуры фМРТ, о чем подробно написано в разделе \ref{intro}. Поэтому для повышения статистической значимости анализа предлагается брать усредненную активность по объектам подвыборки. Для этого рассмотрим конкатенацию временных рядов фМРТ и стимула вдоль временной координаты. Формально для подвыборки $\mathfrak{D}_k$ получаем:
\[
\bX^k = \bX_1 \oplus \bX_2 \oplus \ldots \oplus \bX_{N_k},
\]
\[
\bm{s}^k = \bm{s}_1 \oplus \bm{s}_2 \oplus \ldots \oplus \bm{s}_{N_k},
\]
\[\bX^k \in \mathbb{R}^{\tau N_k \times X \times Y \times Z}, \quad \bm{s}^k \in \{0, 1\}^{\tau N_k},\]
где операция $(~\cdot~\oplus~\cdot~)$~--- конкатенация по первой координате.
К полученным рядам $\bX^k$ и $\bm{s}^k$  применяем метод \textit{Cross-Correlation Weighting} с гиперпараметрами $h_k,~k_s$, считаем, что задержка учтена $\Delta t$ = 0. Решено не делать шаг с Upsample, так как применение Average Pooling к тензорам фМРТ позволяет уменьшить влияние аномальных или шумовых вокселей на анализ активности головного мозга. Получаем для категории стимула $k$ сжатую бинарную маску активности $\mathcal{M}^k \in \{0, 1\}^{X/k_s\times Y/k_s \times Z/k_s}$. 
\begin{definition}\label{def:def6}
Операция применения бинарной маски активности к ряду фМРТ:
пусть $\bX \in \mathbb{R}^{\tau \times X \times Y \times Z}$~--- временной ряд фМРТ и $\mathcal{M} \in \{0, 1\}^{X \times Y \times Z}$~--- бинарная маска активности головного мозга. Тогда результат применения маски $\mathcal{M}$ к $\mathbf{X}$ определяется как:
\begin{equation*}
\mathbf{Z} = \mathcal{M} \bullet \mathbf{X} = [\bz_{1}, \ldots, \bz_{\tau}],
\end{equation*}
где $\bz_{t} \in \mathbb{R}^{h}$ содержит значения $\bx_{t}$, соответствующие ненулевым элементам в маске $\mathcal{M}$, а $h$ --- число этих элементов. В результате получаем матрицу $\bZ \in \mathbb{R}^{h\times \tau}$.
\end{definition}

\paragraph*{Классификация сегментов временного ряда.}
Задана выборка:
\begin{equation*}
    \mathfrak{D} = \{(\bX_{j}, y_j),~\bX_{j}\in \mathbb{R}^{\tau\times X\times Y \times Z} \ | \ {j} = 1, \ldots, N \}.
\end{equation*}
Кроме того, для каждой категории стимулов задана сжатая с ядром $k_s$ бинарная маска активности:
\begin{equation*}
    \bm{M} = \{\mathcal{M}^k \in \{0, 1\}^{X/k_s\times Y/k_s \times Z/k_s}\ | \ k = 1, \ldots, C\}.
\end{equation*}
Искомое отображение $g: \bX \rightarrow \{1,\ldots, C\}$ представляется в виде суперпозиции:
\begin{equation}g \coloneqq \bm{\varphi} \circ \bm{\psi} \circ \mathcal{A}, 
\end{equation}
\vspace{-0.8cm}
\begin{align*}
        & \mathcal{A}: \bX \to \mathbb{R}^{\tau \times X/k_s \times Y/k_s \times Z/k_s}
	\text{~--- Average Pooling,}        \\
	 & \bm{\psi}: \mathbb{R}^{\tau \times X/k_s \times Y/k_s \times Z/k_s} \to \mathbb{R}^d
	\text{~--- векторизатор,}        \\
	 & \bm{\varphi}: \mathbb{R}^d \to \{1,\ldots, C\}
	\text{~--- классификатор.}
\end{align*}
Отображение $\mathcal{A}$~--- применение 3d Average Pooling с ядром $k_s$ к каждому тензору фМРТ.

Построим отображение $\bm{\psi}$ и определим размерность эмбеддингов $d$. Обозначим число ненулевых элементов в $\mathcal{M}^k$ как $h_k,~k = 1, \ldots, C$. Отображение $\bm{\psi}$ является конкатенацией отображений $\bm{\psi}_k,~k = 1, \ldots, C$:
\begin{equation}
    \bm{\psi} = \bm{\psi}_1 \oplus \ldots \oplus \bm{\psi}_C, \quad \bm{\psi}_k: \bX \rightarrow \mathbb{R}^{d_k}, \quad d = \sum_{k=1}^C d_k.
\end{equation}
Для каждой категории $k \in \{1, \ldots, C\}$ отображение $\bm{\psi}_k$ представимо в виде суперпозиции:
\begin{equation}
    \bm{\psi}_k = \bm{\pi}_k \circ \bm{f}_k.
\end{equation}
Здесь $\bm{f}_k:\mathbb{R}^{\tau \times X/k_s \times Y/k_s \times Z/k_s} \rightarrow \mathbb{R}^{h_k\times \tau}$~--- применение маски активности $\mathcal{M}^k$, см. Опр. \ref{def:def6}.
Отображение $\bm{\pi}_k: \mathbb{R}^{h_k\times \tau} \rightarrow \mathbb{R}^{d_k}$~--- проекция на риманово касательное пространство с последующей векторизацией.

Подробнее остановимся на методе $\bm{\pi}_k$ трансформации признакового пространства в терминах римановой геометрии \citep{barachant2010riemannian, barachant2011multiclass}. В работе \citep{barachant2011multiclass} метод называется \textit{Tangent Space Mapping}.
Первым шагом данного алгоритма является формирование пространства центрированных признаков. Введем следующие обозначения: 
$$\bY^k_j = \accentset{\circ}{\bm{f}_k(\mathcal{A}(\bX}_j)), \quad j = 1, \ldots, N,$$

\begin{equation*}
	\bY^k_j= \left[
\begin{array}{cccc}
y^{kj}_{11} & y^{kj}_{12} & \ldots & y^{kj}_{1\tau}\\
y^{kj}_{21} & y^{kj}_{22} & \ldots & y^{kj}_{2\tau}\\
\vdots & \vdots & \ddots & \vdots\\
y^{kj}_{h_k1} & y^{kj}_{h_k 2} & \ldots & y^{kj}_{h_k\tau}
\end{array}
\right]
	= \begin{bmatrix}
		\bm{y}^{kj}_1\\
            \bm{y}^{kj}_2\\
		\vdots\\
		\bm{y}^{kj}_{h_k}
		\end{bmatrix},\quad j = 1, \ldots, N,
	\end{equation*}
где $\bm{y}^{kj}_i, \quad i = 1, \ldots, h_k$~--- центрированные временные ряды.
Тогда ковариационная матрица для $\bY^k_j$~--- многомерного временного ряда:
$$ \bm{R}^k_j = \dfrac{1}{\tau-1}{\bY^k_j\bY^k_j}^{\T}, \quad \bm{R}^k_j \in \mathbb{R}^{h_k\times h_k}, \quad j = 1, \ldots, N.$$

Известно, что пространство, состоящее из матриц ковариации, представляет собой 
Риманово многообразие \citep{barachant2010riemannian}. 
В каждой точке риманова многообразия имеется касательная плоскость с 
определенным на ней скалярным произведением. Общая касательная плоскость для проекции матриц ковариации в выборке формируется в точке среднего геометрического по римановой метрике 
известных ковариационных матриц. Среднее геометрическое симметричных положительно определенных матриц \citep{moakher2005differential} имеет вид:
$$\bm{R}_k = \mathfrak{G}\left(\bm{R}^k_1,\dots,\bm{R}^k_N\right) = \underset{\bm{R}}{\arg \min}\sum_{j = 1}^N
\delta^2_R(\bm{R},~\bm{R}^k_j),$$
где риманова метрика или геодезическое расстояние определяется следующим образом:
$$\delta_R(\bm{R}_1,~\bm{R}_2) = \|\log (\bm{R}_1^{-1}\bm{R}_2)\|_F = \sqrt{\sum_{i = 1}^{3N} \log^2\lambda_i}.$$
Здесь $\lambda_i$~--- собственные значения матрицы $\bm{R}_1^{-1}\bm{R}_2$. В работе \citep{barachant2010riemannian}
получено, что для каждой ковариационной матрицы $\bm{R}^k_j$ существует проекция $\bm{\pi}^k_j$ на касательное пространство.
Кроме того, определено отображение:
$$\text{Exp}_{R}(\bm{\pi}^k_j) = \bm{R}^k_j = \bm{R}_k^{\frac{1}{2}} \exp\left(\bm{R}_k^{-\frac{1}{2}}\bm{\pi}^k_j\bm{R}_k^{-\frac{1}{2}}\right) \bm{R}_k^{\frac{1}{2}}$$
$$\text{Log}_{R}(\bm{R}^k_j) = \bm{\pi}^k_j = \bm{R}_k^{\frac{1}{2}} \log\left(\bm{R}_k^{-\frac{1}{2}}\bm{R}^k_j\bm{R}_k^{-\frac{1}{2}}\right) \bm{R}_k^{\frac{1}{2}}$$
После проектирования каждой ковариационной матрицы $\bm{R}^k_j$ с помощью $\text{Log}_{R}(~\cdot~)$, получаем
матрицы $\bm{\pi}^k_j \in \mathbb{R}^{h_k\times h_k}$. 
Последним шагом метода является векторизация.
Процесс векторизации каждой матрицы $\bm{\pi}^k_j$ в пространство с евклидовой метрикой~---
последовательная запись элементов верхнетреугольной матрицы от $\bm{\pi}^k_j$, 
где диагональные элементы имеют коэффициент 1, а недиагональные~--- коэффициент $\sqrt{2}$. 
Получаем эмбеддинги:
\begin{equation*}
	\hat{\bm{\pi}}^k_j = \begin{bmatrix}
		\bm{\bm{\pi}}^k_j({1,~1}) & \sqrt{2} \bm{\pi}^k_j({1,~2}) &  \ldots  &  \sqrt{2}\bm{\pi}^k_j(1,~h_k) & \bm{\pi}^k_j({2,~2}) & \ldots & \bm{\pi}^k_j({h_k,~h_k})
		\end{bmatrix}^{\T},
\end{equation*}
\begin{equation}
    \hat{\bm{\pi}}^k_j \in \mathbb{R}^{d_k},\quad d_k = \dfrac{h_k(h_k+1)}{2}.
\end{equation}
Важно подчеркнуть, что при таком подходе извлекаются пространственно-временные характеристики, которые демонстрируют степень соответствия объекта маске активности конкретного класса.

В качестве классификатора $\bm{\varphi}$ рассматриваются традиционные варианты, такие как логистическая регрессия и перцептрон с двумя скрытыми слоями.

\section{Вычислительный эксперимент}
Для проведения вычислительного эксперимента используются данные фМРТ из исследования \cite{haxby2001distributed}, собранные при изучении представлений лиц и объектов в вентральной височной коре.

Набор данных содержит показания фМРТ 6 пациентов. Каждый испытуемый прошел 12 сеансов. В каждом сеансе пациент пассивно рассматривал черно-белые изображения восьми категорий, сгруппированные в блоки по 24 секунды, разделенные периодами отдыха. Каждое изображение демонстрировалось в течение 500 мс с последующим интервалом между стимулами 1500 мс. Данные фМРТ головного мозга были записаны с частотой 2.5 $\text{с}^{-1}$. Характеристики выборки приведены в Таблице~\ref{table:sample_2}.
\begin{table}[h!]
	\centering
	\begin{tabular}{c|cc}
            \toprule
		Название                       & Обозначение & Значение             \\
		\midrule
		Количество снимков в сеансе & $T$ & 121 \\ 
		Частота снимков фМРТ           & $\mu$       & 2.5 $\text{с}^{-1}$ \\ 
		Размерности снимка             & $X, Y, Z$   & 40, 64, 64           \\ \bottomrule
	\end{tabular}
        \vspace{10pt}
        \caption{В таблице представлены основные параметры рядов фМРТ из выборки.}
	\label{table:sample_2}
\end{table}
\vspace{-0.3cm}
Кроме того, набор данных содержит временные ряды стимулов и маски активных областей мозга, полученные нейробиологами. Эти области были определены для каждого участника эксперимента индивидуально. Маски активности были созданы путем объединения этих областей для всех участников эксперимента. Код экспериментов представлен в репозитории GitHub\footnote{https://github.com/DorinDaniil/Spatial-and-Temporal-Characteristics}.
\subsection{Взвешивание вокселей фМРТ снимков}
Для демонстрации работы алгоритма был выбран 1-ый испытуемый, размер ядра $k_s = 4$, $h=10$. Рассмотрен 28-ой срез по первой координате.
На Рис.~\ref{fig:example1} представлены срезы снимка из выборки с соответствующими масками активности. На Рис.\myfigref{fig:example1}{fig:example-a} цветом отмечены области мозга, полученные методом \textit{Cross-Correlation Weighting}. На Рис.\myfigref{fig:example1}{fig:example-b} цветом показаны области мозга, полученные при статистическом анализе. Наконец, на Рис.\myfigref{fig:example1}{fig:example-c} цветом представлена разметка нейробиологов.

На основе статистического анализа, описанного в разделе \ref{CCW}, экспериментально проверено, что корреляция взвешенных областей со стимулом является статистически значимой. Кроме того, полученные области близки к разметке нейробиологов.

\begin{figure}[h!]
	\centering
	\subfloat[\fontsize{12pt}{12pt}\selectfont\centeringПредложенный метод]{\label{fig:example-a}{\includegraphics[width=0.3\textwidth]{figures/fmri_weighting/haxby_method.png}}}
	\hfill
	\subfloat[\fontsize{12pt}{12pt}\selectfont\centeringСтатистически значимые области]{\label{fig:example-b}{\includegraphics[width=0.3\textwidth]{figures/fmri_weighting/haxby_rejected.png}}}
	\hfill
	\subfloat[\fontsize{12pt}{12pt}\selectfont\centeringРазметка нейробиологов]{\label{fig:example-c}{\includegraphics[width=0.3\textwidth]{figures/fmri_weighting/haxby_true.png}}}
 \caption{\textbf{Анализ метода взвешивания вокселей фМРТ снимков.} Полученные предложенным методом области очень близки к истинной разметке. Корреляция взвешенных вокселей со стимулом является статистически значимой.}
\label{fig:example1}
\end{figure}
Рассмотрено качество работы метода на неинформативных данных. Используется временной ряд фМРТ 1-го испытуемого и случайно сгенерированный бинарный ряд стимула. На Рис.~\ref{fig:correctness} представлены срезы снимка фМРТ, цветом отмечены области мозга, предсказанные методом.
\begin{figure}[h!]
	\centering
	\subfloat{\label{fig:correctness-a}{\includegraphics[height=0.3\textwidth]{figures/fmri_weighting/slice_dim_1_slice_20.png}}}
	\hfill
	\subfloat{\label{fig:correctness-b}{\includegraphics[height=0.3\textwidth]{figures/fmri_weighting/slice_dim_0_slice_28.png}}}
	\hfill
	\subfloat{\label{fig:correctness-c}{\includegraphics[height=0.3\textwidth]{figures/fmri_weighting/slice_dim_2_slice_24.png}}}
 \caption{\textbf{Анализ метода взвешивания на неинформативных данных.} Представлены срезы с трех измерений. В качестве временного ряда стимула рассмотрен случайно сгенерированный бинарный ряд. Метод предсказывает случайные области, не имеющие отношения к активности головного мозга.}
\label{fig:correctness}
\end{figure}
Модель предсказывает случайные области, не имеющие отношения к активности головного мозга. Аналогично предыдущему эксперименту проведены статистические тесты. По результатам ни одна из полученных областей не является значимой, что свидетельствует о корректности метода взвешивания.
\subsection{Классификация сегментов временного ряда фМРТ}
Рассматриваются данные фМРТ первых трех испытуемых. Для получения сегментов ряда фМРТ был применен алгоритм сегментации, описанный в разделе \ref{segmentation}. В Таблице~\ref{table:sample_3} приведены параметры, рассчитанные для каждой из трех выборок, полученных в результате сегментации.
\begin{table}[h!]
	\centering
	\begin{tabular}{c|cc}
		\toprule
		Название & Обозначение & Значение \\
            \midrule
		Число объектов & $N$ & 96 \\ 
		  Длина каждого сегмента & $\tau$ & 19 \\
	   Число классов стимула  & $C$   & 8  \\
        Число объектов на каждый класс & $N_k$   & 12  \\ \bottomrule  
	\end{tabular}
        \vspace{10pt}
        \caption{Параметры каждой выборки, полученной в результате сегментации временных рядов фМРТ испытуемого.}
	\label{table:sample_3}
 \vspace{-0.3cm}
\end{table} 
Произведено разделение каждой выборки на тренировочную и тестовую в соотношении $80\%$ к $20\%$ соответственно. Для оценки качества классификации сегментов фМРТ использовались метрики Accuracy, Macro-averaged F1 score и Micro-averaged F1 score.

В ходе экспериментов фиксировались следующие параметры модели: число областей для каждого класса $h_k = 10,~k=1,\ldots, C$, размер ядра $k_s = 4$. Использовалась логистическая регрессия со стратегией <<один против всех>> и единичным коэффициентом $l2$-регуляризации. Кроме того, рассмотрен перцептрон, содержащий два скрытых слоя по 100 нейронов в каждом и сигмоидную функцию активации.

В Таблице~\ref{results} представлены усредненные по трем испытуемым значения метрик на тесте. Видно, что модель способна выучивать некоторую зависимость даже при небольшом объеме данных и значительном числе классов.
\begin{table}[h!]
	\centering
	\begin{tabular}{c|cc}
		\toprule
		Классификатор & Accuracy &  Macro F1 score \\
		\midrule Логистическая регрессия & 0.60 $\pm$ 0.05& 0.56 $\pm$ 0.05\\ %\hline  
          Перцептрон  & 0.70 $\pm$ 0.06 & 0.64 $\pm$ 0.06\\ \bottomrule
	\end{tabular}
        \vspace{10pt}
        \caption{Усредненные по испытуемым значения метрик на тесте.}
        \label{results}
\end{table} 
\vspace{-0.3cm}

Для сравнения эффективности предложенного метода классификации рассмотрены две упрощенные модели.
Первая модель не использует векторизацию с помощью \textit{Tangent Space Mapping}. В ней временные ряды после применения масок каждого класса выпрямляются в вектор, конкатенируются и подаются на классификатор.
Во второй модели маска активности подсчитывается в среднем по всем временным рядам без учета категорий стимула. После применения маски используется векторизация с помощью \textit{Tangent Space Mapping}.


Результаты работы всех трех методов на данных второго испытуемого представлены в Таблице~\ref{comperison}. В качестве классификатора использовалась логистическая регрессия.
\begin{table}[h!]
	\centering
	\begin{tabular}{c|ccc}
		\toprule
		Метод & Accuracy &  Macro F1 score & Micro F1 score\\
		\midrule
		Предложенный & \textbf{0.65} & \textbf{0.60} & \textbf{0.65}\\   
           Без \textit{Tangent Space Mapping} & 0.15 & 0.12 & 0.15\\  
           Без масок активности & 0.40 & 0.38 & 0.40\\ \bottomrule 
	\end{tabular}
        \vspace{10pt}
        \caption{Влияние отдельных компонент метода на качество классификации.}
	\label{comperison}
 \vspace{-0.3cm}
\end{table} 

Наибольшее снижение метрик наблюдается при исключении проекции на риманово касательное пространство, что подчеркивает значимость этого шага в предложенном методе. Кроме того, отсутствие масок активности для каждого класса стимула также приводит к снижению качества классификации, демонстрируя важность учета индивидуальных особенностей каждого стимула.

Полученные результаты свидетельствуют о том, что предложенный метод эффективно извлекает пространственно-временные характеристики нейронной активности, которые являются ключевыми для задачи декодирования.

\section{Заключение}
В данной работе предложен новый метод взвешивания активных областей мозга в задаче декодирования временных рядов фМРТ, демонстрирующий качество работы на реальных данных фМРТ. Полученные методом области показали хорошее соответствие с разметкой нейробиологов, а статистическая значимость взвешенных вокселей подтверждена статистическими тестами. Корректность метода была также подтверждена экспериментом со случайным рядом стимула.
Кроме того, был разработан алгоритм сегментации временного ряда фМРТ для аугментации данных, а также предложена модель классификации сегментов временного ряда фМРТ. Особенностью данного метода является учет пространственно-временных характеристик благодаря применению масок активности головного мозга и извлечению признаков с помощью метода \textit{Tangent Space Mapping}, основанного на римановой геометрии.
Экспериментальные результаты показали, что исключение отдельных компонент метода приводит к значительному снижению качества классификации, что свидетельствует о важности пространственно-временных характеристик, извлекаемых данным методом, для достижения высокой точности классификации. Таким образом, предложенный метод может быть полезен для анализа и интерпретации нейронных данных, а также для разработки новых подходов к декодированию нейронной активности.
\newpage

\bibliographystyle{unsrt}
\bibliography{references.bib}

\end{document}